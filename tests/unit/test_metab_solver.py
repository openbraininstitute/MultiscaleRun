from multiscale_run.metabolism import model, initial_conditions
from multiscale_run.metabolism.indexes import UIdx
from scipy.integrate import solve_ivp
import numpy as np



# def report_differences(a, b, tol=1e-6):
#     a = np.asarray(a, float)
#     b = np.asarray(b, float)

#     diff_idx = np.where(np.abs(a - b) > tol)[0]
#     l = UIdx.as_list()

#     for i in diff_idx:
#         name = l[i]
#         print(f"{i:3d}  {name:30s}  a={a[i]: .6g}  b={b[i]: .6g}  diff={a[i]-b[i]: .6g}")

#     return diff_idx

julia_u = [1.82084728579186e-5, 54.88513909303926, 0.6405401937956016, 0.3146584474671007, 0.0155067120830932, 0.1318502545732708, 0.0314865025158087, 0.7487433393982624, 1.8512566606017409, 0.2084517745966104, 1.129008031715835, 17.22873019667985, 1.385172099080793, 0.0572067246036489, 0.0, 1.2787221400985913, 0.0560549944512344, 19.999860977665755, 152.33918637408712, 2.7, 1.35, 3.981071705487114e-5, 1.3846319642170142, 0.05774639699941189, 0.0703303834778912, 0.3877284278881228, 0.0113308326310003, 0.3913984292428137, 0.0027652024434962, 0.0027278355391079, 0.0730279198447203, 0.0001, 0.0331278125743512, 0.3414510962627293, 0.040486317761993, 0.0008938613668892, 3.471725572540322e-5, 0.0459280204781883, 0.0020508302306412, 0.0028617229372728, 0.002235, 0.2981203841045341, 1.4, 1.4, 10.001887920296111, 0.45, 0.01, 0.2, 10.000000420931526, 0.0041407804365102, 1.82084728579186e-5, 54.88513909303926, 0.6254020744170418, 0.3622495632039702, 0.0106589284924907, 0.1075501448904177, 0.0390586574723978, 0.8554395319513812, 1.7445604680486215, 0.2082789745472756, 1.1443189511420615, 17.625288473162165, 1.29745793823728, 0.0443466995414318, 0.0, 1.1823280190768068, 0.0436294958926607, 19.999931107524688, 155.39201516889315, 2.7, 1.35, 3.981071705487114e-5, 1.2971907639974427, 0.045, 0.0500591772559637, 0.2552499695609829, 0.0044682268709836, 0.5865999694835419, 0.0016699868314113, 0.0025413688391748, 0.0151591579926322, 0.0001, 0.0360692382798456, 0.358985824746709, 0.0042886443294129, 0.00312, 0.0006, 0.0129832531511687, 0.4001678075113439, 0.1999103267772767, 0.2497981926884056, 0.2994675379035365, -94.73739998434873, 16.27886560396611, 100.79307843484172, 4.999999999999998, 2.5e-5, -68.00932293426199, 9.999999999999996, 0.9811237297560303, 0.0346735745461176, 5.436689205733492e-5, 0.0355392388163259, 7.45614720951229e-6, 0.0, 1.1852340589842885e-6, 0.6531565346093099, 5.31000955574647e-5, 0.4, 0.0012469723667279, 0.0237000024973173, 3.143871670033718e-5, 0.0585277029194496, 7.105220869902977, 4.555436497117541, 1.4036921120261527, 1.302331013714969, 1.2215129412034005, 1.0034276408975709, 0.9117230433328604, 0.0451803110921908, 0.0614224256490154, 0.0073671881089935, 0.0101391530037056, 0.0094588621787074, 0.0299767447273059, 0.0121698969225108, 13.99969995417289, 1.0e-5, 1.0e-5, 0.0128112803617315, 0.0012351454067088, 0.0022568560606488, 0.0032208035336226, 0.0037897580104066, 0.0060805407271592, 0.0080305626199569, 0.10927809092221, 20.0, 20.0, 0.0176506715347894, 0.0214636041341032, 0.0019612387455003, 0.0023600313501276, 0.0011299114036925, 0.0013498159787353, 0.0988456289470794, 0.0294824423032595, 0.6887631395085969, 0.6223377821910432, 0.6224222941358745, 0.62189156291357, 0.0300300281880248, 0.0300061794837243, 2.7223858669789458e-6, 3.019823774010181e-6, 0.0026154588421574, 0.0018252228026121, 0.0005499402428921, 0.0006682285740983, 1.564984868864245e-5, 2.6065883215538546e-5, 0.0168344242629796, 0.0204705104083548, 0.0198078394367428, 0.249543115567966, 0.0066329544563609, 0.0061388697486627, 1.200006238770546, 4.300000202932421, 0.0119968806147281, 0.0429998985338233, 5.053977657681814, 4.98986852470732, 5.0757940916174356, 4.927691727614907, 0.0391827032589541, 0.0, 0.109, 0.23, 0.0029999, 0.0013314628973952, 0.0686685371026043]

julia_p = [5.804824049643817e-24, -6.144438016775923e-21, 0.82687338501292, 0.0001, 0.0001, 0.023]
julia_t = 0.0
julia_du = [0.0, -2.6657579488479378e-15, 4.343289610930117e-7, -1.2447258596071098e-6, -2.2037415128222212e-7, -4.494209704449395e-7, -3.1630068578203385e-8, 2.5241801909402644e-6, -2.5241801909402644e-6, 8.036320250310131e-7, -1.2379609861240247e-6, 1.3138183488844224e-5, -0.005401196618914745, 0.004942870179299269, 0.009910446212986292, -0.0010121507402251052, -1.1449017176888763e-5, 2.2488059748088367e-9, 3.656042566359458e-5, 0.0, 0.0, 0.0, 0.023939598087199754, 0.0, 7.621688651194221e-7, 4.169762110405322e-6, 2.0441916139283742e-7, -0.0001285229013210395, -1.2918594948683825e-7, 6.091339109721457e-8, -1.394614109277906e-6, 0.0, 2.537148907318678e-10, 2.824877515585953e-7, 5.727610291781122e-8, 6.4869403014745e-8, 1.0996455471814056e-8, -7.92113142786266e-7, 5.519364483080056e-8, 5.132604936436709e-8, 0.0, -0.008133610267505129, 0.0, 0.0, 1.3616025951497762e-6, 0.0, 0.0, 0.0, 3.0417035270450653e-9, 6.612371004684897e-7, 0.0, -2.6657579488479378e-15, -1.9514088347814748e-5, -3.6066247026608766e-5, 9.986411775431553e-7, 5.092825145869284e-6, -1.5747960089677882e-6, -8.618349260705603e-5, 8.618349260705603e-5, -2.614659538363513e-5, 4.566068373144988e-5, -0.00014866139991703833, -8.03511420784932e-6, 7.374132234158054e-6, 0.009910446212986292, -7.664616004139389e-6, 7.669674200148303e-6, -2.3682582909244913e-8, -0.0021113571797726606, 0.0, 0.0, 0.0, 7.12071677352224e-5, 0.0, 2.0786036517040243e-5, 0.00010708735804260193, 3.191563744792875e-6, -8.908904065560136e-5, 1.6525909349622298e-7, 1.1043823167655649e-6, -1.1630758894339802e-5, 0.0, 8.032252911362053e-8, 7.107036611454444e-6, -1.269641410261788e-6, 0.0, 0.0, -1.4635816021277281e-6, 5.471607909827959e-8, 1.1112626318035974e-7, -7.171225155706412e-7, -0.0001457052477259786, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, -7.51244754341985e-6, -5.343234758590977, -0.4110203221899585, -1.999641172617528e-6, -2.144607233370288e-6, 8.393692378014911e-5, -5.426672895961389e-6, 8.255256004437552e-5, -8.872640294897244e-5, -8.701104468160814e-5, -2.720394267602508e-8, -3.3064189388821324e-7, 3.4718409338847095e-8, -2.306542254290611e-6, 1.573992642645483e-6, 8.847005241898853e-7, 0.0, 0.0, 2.1770129968009177e-6, 7.69608345365584e-9, -3.5165838653718065e-7, 4.304582012018554e-10, 1.4912553162596195e-7, -5.017657543869569e-7, -1.1054194580190427e-6, -1.4327789018111006e-6, 0.0, 0.0, 6.318409534779301e-7, -6.989307322442448e-7, 1.2713406831628415e-8, -1.8993019601162842e-7, -5.131218331778237e-7, -1.7319338407005558e-7, 2.8439197199622845e-7, 4.247601281240701e-6, -0.2649395761065743, 9.618767380801738e-5, 9.622543275690835e-5, 9.628179113106792e-5, 1.3464347833284235e-10, -7.860410984638407e-8, 1.296538343267123e-12, -1.3345054510234544e-10, 4.5384749018835546e-10, -5.115504431423695e-8, -1.8260781566871963e-10, -1.2566430572204723e-7, -1.1399796850854876e-12, -1.885651548290011e-9, -8.314360141830571e-9, -1.5987134951396325e-6, 3.083002892536929e-7, -1.7159047088728197e-7, 1.4986011038096362e-7, 2.278491507289222e-7, -2.5964763396907037e-10, 1.791339036067343e-8, 4.214888616078938e-11, -7.3999695357918754e-9, 0.0, 0.0001665567169747929, 0.0, 6.8926301559392444e-6, -8.4409159786282e-7, 0.0, 0.0, 0.0, 0.0, 2.266339307679665e-8, -2.266339307679665e-8]
julia_tspan_m = (0.0, 0.00025)

def test_compute_u0_vs_julia():
    du = model.compute_du(julia_u, julia_p, julia_t)
    np.testing.assert_allclose(du, julia_du)

def test_solver():
    sol = solve_ivp(
            lambda t, u: model.compute_du(u, julia_p, t),
            julia_tspan_m,
            julia_u,
            method="Radau",
            vectorized=False,
        )
    assert sol.success


if __name__ == "__main__":
    test_compute_u0_vs_julia()
    test_solver()

